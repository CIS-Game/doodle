<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Кто громче?</title>
  <style>
    :root {
      --bg: #060821;
      --card: #11162e;
      --accent: #ff4b5c;
      --accent2: #36d1dc;
      --text: #f7f7ff;
      --radius: 20px;
      --gap: 16px;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing:border-box; margin:0; padding:0; }

    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family:var(--font-main);
    }

    .game{
      width:100%;
      max-width:480px;
      padding:20px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      text-align:center;
      box-shadow:0 10px 25px rgba(0,0,0,0.45);
    }

    h1{
      font-size:min(7vw,30px);
      margin-bottom:8px;
    }
    .subtitle{
      font-size:min(4vw,16px);
      opacity:.8;
      margin-bottom:18px;
    }

    .score{
      font-size:min(6vw,26px);
      margin-bottom:4px;
    }
    .best{
      font-size:min(4vw,15px);
      opacity:.75;
      margin-bottom:18px;
    }

    .meter{
      width:100%;
      height:26px;
      border-radius:999px;
      background:#2a3257;
      overflow:hidden;
      margin-bottom:10px;
    }
    .meter-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .1s linear;
    }

    .db-label{
      font-size:min(4.5vw,17px);
      margin-bottom:18px;
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    button{
      border:none;
      border-radius:16px;
      padding:12px;
      font-size:min(4.8vw,18px);
      font-weight:700;
      color:#fff;
      background:var(--accent);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    button.secondary{
      background:#3b4ba8;
    }
    button:active{
      transform:scale(.97);
    }

    .status{
      margin-top:10px;
      font-size:min(3.8vw,15px);
      min-height:1.2em;
      opacity:.85;
    }
  </style>
</head>
<body>
<div class="game">
  <div class="card">
    <h1>Кто громче?</h1>
    <div class="subtitle">Крикни в микрофон, чтобы набрать очки</div>

    <div class="score" id="score">Очки: 0</div>
    <div class="best" id="best">Рекорд: 0</div>

    <div class="meter">
      <div class="meter-fill" id="meterFill"></div>
    </div>
    <div class="db-label" id="dbLabel">Громкость: 0</div>

    <div class="controls">
      <button id="startBtn">Старт / Стоп</button>
      <button class="secondary" id="resetBtn">Сброс рекорда</button>
    </div>

    <div class="status" id="status"></div>
  </div>
</div>

<script>
  let audioContext = null;
  let analyser = null;
  let micStream = null;
  let rafId = null;
  let running = false;

  const meterFill = document.getElementById('meterFill');
  const dbLabel   = document.getElementById('dbLabel');
  const scoreEl   = document.getElementById('score');
  const bestEl    = document.getElementById('best');
  const statusEl  = document.getElementById('status');
  const startBtn  = document.getElementById('startBtn');
  const resetBtn  = document.getElementById('resetBtn');

  let bestScore = 0;

  async function start() {
    if (running) { stop(); return; }
    try {
      // запрос доступа к микрофону
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true },
        video: false
      });

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(micStream);

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 1024;
      analyser.smoothingTimeConstant = 0.8;
      source.connect(analyser);                               // [web:13][web:16]

      running = true;
      startBtn.textContent = 'Стоп';
      statusEl.textContent = 'Говори или кричи в микрофон!';
      scoreEl.textContent = 'Очки: 0';
      animate();
    } catch (err) {
      statusEl.textContent = 'Нет доступа к микрофону.';
      console.error(err);
    }
  }

  function stop() {
    running = false;
    startBtn.textContent = 'Старт / Стоп';
    if (rafId) cancelAnimationFrame(rafId);
    if (micStream) {
      micStream.getTracks().forEach(t => t.stop());
      micStream = null;
    }
    if (audioContext) {
      audioContext.close();
      audioContext = null;
    }
    statusEl.textContent = 'Игра остановлена.';
  }

  function animate() {
    if (!running || !analyser) return;

    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);                      // [web:18][web:21]

    let sum = 0;
    for (let i = 0; i < data.length; i++) sum += data[i];
    const avg = sum / data.length; // 0–255

    const percent = Math.min(100, (avg / 255) * 100);
    meterFill.style.width = percent + '%';
    dbLabel.textContent = 'Громкость: ' + Math.round(percent);

    const score = Math.round(percent * 10);
    scoreEl.textContent = 'Очки: ' + score;

    if (score > bestScore) {
      bestScore = score;
      bestEl.textContent = 'Рекорд: ' + bestScore;
    }

    rafId = requestAnimationFrame(animate);
  }

  startBtn.addEventListener('click', start);
  resetBtn.addEventListener('click', () => {
    bestScore = 0;
    bestEl.textContent = 'Рекорд: 0';
  });
</script>
</body>
</html>
